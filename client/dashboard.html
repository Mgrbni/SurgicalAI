<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SurgicalAI Dashboard (Next)</title>
  <link rel="stylesheet" href="dashboard.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="api.js"></script>
</head>
<body x-data="dashApp()" class="min-h-screen flex flex-col">
  <header class="shadow bg-white/80 backdrop-blur sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <h1 class="text-xl font-semibold">SurgicalAI</h1>
      <span class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-700">Not for clinical use</span>
      <div class="ml-auto flex items-center gap-3 text-sm">
        <div x-text="health.provider + ' / ' + health.model" class="font-mono"></div>
        <button class="btn-secondary" x-on:click="refreshHealth()" :disabled="checkingHealth">Health</button>
        <select x-model="theme" x-on:change="applyTheme()" class="border rounded px-2 py-1 text-sm">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>
  </header>
  <main class="flex-1 max-w-6xl mx-auto w-full px-4 py-6 grid gap-6 md:grid-cols-2">
  <section class="card p-5 space-y-4" aria-label="Upload & Parameters">
      <h2 class="font-semibold text-lg">Image & Parameters</h2>
      <div class="border-2 border-dashed rounded-lg p-6 text-center cursor-pointer relative" x-on:click="$refs.file.click()" @dragover.prevent @drop.prevent="handleDrop($event)">
        <input type="file" accept="image/*" x-ref="file" class="hidden" @change="fileChosen($event)" />
        <template x-if="!imagePreview">
          <div class="text-gray-500 text-sm">
            <p class="mb-1 font-medium">Drop or click to select image</p>
            <p>JPEG / PNG up to 10MB</p>
          </div>
        </template>
        <template x-if="imagePreview">
          <div class="space-y-2">
            <img :src="imagePreview" alt="preview" class="max-h-56 mx-auto rounded shadow" />
            <div class="flex justify-center gap-2 text-xs text-gray-600">
              <span x-text="selectedFile?.name"></span>
              <span>&middot;</span>
              <span x-text="formatSize(selectedFile?.size)"></span>
              <button type="button" class="text-red-600 hover:underline" @click.stop="clearImage()">Remove</button>
            </div>
          </div>
        </template>
      </div>
      <div class="grid gap-4">
        <label class="grid gap-1 text-sm">
          <span class="font-medium">Anatomical Site *</span>
          <select x-model="form.site" class="input" required>
            <option value="">Select...</option>
            <template x-for="s in sites" :key="s.value">
              <option :value="s.value" x-text="s.label"></option>
            </template>
          </select>
        </label>
        <label class="grid gap-1 text-sm">
          <span class="font-medium">Suspected Type (optional)</span>
          <input x-model="form.suspected" placeholder="e.g. melanoma" class="input" />
        </label>
        <div class="grid grid-cols-2 gap-4">
          <label class="grid gap-1 text-sm">
            <span class="font-medium">Age</span>
            <input type="number" min="0" x-model.number="form.age" class="input" />
          </label>
          <label class="grid gap-1 text-sm">
            <span class="font-medium">Sex</span>
            <select x-model="form.sex" class="input">
              <option>Male</option>
              <option>Female</option>
            </select>
          </label>
        </div>
        <fieldset class="grid gap-2 text-sm">
          <legend class="font-medium">Lesion Flags</legend>
          <label class="flex items-center gap-2"><input type="checkbox" x-model="form.prior_histology"/> <span>Prior histology</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" x-model="form.ill_defined_borders"/> <span>Ill-defined borders</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" x-model="form.recurrent"/> <span>Recurrent lesion</span></label>
        </fieldset>
        <details class="border rounded p-3 bg-gray-50/60">
          <summary class="cursor-pointer text-sm font-medium">Patient Risk Factors</summary>
          <div class="mt-3 grid gap-2 text-xs">
            <label class="flex items-center gap-2"><input type="checkbox" x-model="form.risk.smoking"/> <span>Smoking</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" x-model="form.risk.uv"/> <span>Extreme lifetime UV exposure</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" x-model="form.risk.immunosuppression"/> <span>Immunosuppressed</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" x-model="form.risk.family_history"/> <span>Family history melanoma</span></label>
            <label class="flex items-center gap-2"><input type="checkbox" x-model="form.risk.prior_radiation"/> <span>Prior radiation at site</span></label>
            <label class="grid gap-1">
              <span>Fitzpatrick Type</span>
              <select x-model="form.risk.fitzpatrick" class="input">
                <option value="">Unknown</option>
                <option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option>
              </select>
            </label>
          </div>
        </details>
        <div class="flex gap-3 pt-2">
          <button class="btn-primary flex-1" :disabled="!canAnalyze" @click="analyze()">
            <span x-show="!analyzing">Analyze</span>
            <span x-show="analyzing" class="flex items-center gap-2"><span class="loader"></span>Analyzing...</span>
          </button>
          <button class="btn-secondary" type="button" @click="reset()" :disabled="analyzing">Reset</button>
        </div>
        <template x-if="error">
          <div class="p-2 text-sm rounded bg-red-100 text-red-700" x-text="error"></div>
        </template>
        <template x-if="lastRequestId">
          <div class="text-xs text-gray-500">Req: <span x-text="lastRequestId"></span></div>
        </template>
      </div>
    </section>
    <section class="card p-5 space-y-4" aria-label="Results">
      <div class="flex items-center gap-2">
        <h2 class="font-semibold text-lg">Results</h2>
        <span x-show="analyzing" class="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-600 animate-pulse">Running</span>
      </div>
      <template x-if="!results && !analyzing">
        <p class="text-sm text-gray-500">Upload an image and analyze to see results.</p>
      </template>
      <template x-if="results">
        <div class="space-y-6">
          <div>
            <h3 class="font-medium mb-2 text-sm tracking-wide uppercase text-gray-500">Diagnosis Probabilities</h3>
            <div class="space-y-2">
              <template x-for="row in results.sortedDiagnosis" :key="row.condition">
                <div>
                  <div class="flex justify-between text-xs mb-0.5">
                    <span x-text="row.condition"></span>
                    <span x-text="row.percentage + '%'" class="font-medium"></span>
                  </div>
                  <div class="h-2 rounded bg-gray-200 overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500" :style="'width:' + row.percentage + '%'" ></div>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <h3 class="font-medium mb-2 text-sm tracking-wide uppercase text-gray-500">Primary Dx</h3>
              <p class="text-lg font-semibold" x-text="results.primaryDx"></p>
            </div>
            <div>
              <h3 class="font-medium mb-2 text-sm tracking-wide uppercase text-gray-500">Gate</h3>
              <p class="text-sm" x-text="results.gate?.status || 'n/a'"></p>
              <p class="text-xs text-gray-500" x-text="results.gate?.notes"></p>
            </div>
          </div>
          <div class="grid gap-4">
            <template x-if="results.heatmapUrl">
              <div>
                <h3 class="font-medium mb-2 text-sm tracking-wide uppercase text-gray-500">Heatmap</h3>
                <img :src="results.heatmapUrl" alt="heatmap" class="rounded shadow max-h-80 object-contain bg-gray-50" />
              </div>
            </template>
          </div>
          <div class="flex gap-3 flex-wrap">
            <button class="btn-secondary" type="button" :disabled="!results.reportUrl" @click="openReport()">PDF Report</button>
          </div>
        </div>
      </template>
    </section>
  </main>
  <footer class="text-xs text-center py-4 text-gray-500">© SurgicalAI — Experimental Dashboard</footer>
  <script>
    function dashApp(){
      return {
        theme: 'light',
        health: {provider:'...', model:'...', ok:false},
        checkingHealth:false,
        selectedFile:null,
        imagePreview:null,
        analyzing:false,
        error:null,
        lastRequestId:null,
        results:null,
        sites:[],
  form:{site:'', suspected:'', age:null, sex:'Male', prior_histology:false, ill_defined_borders:false, recurrent:false, risk:{smoking:false, uv:false, immunosuppression:false, family_history:false, prior_radiation:false, fitzpatrick:''}},
        init(){
          this.loadSites();
          this.refreshHealth();
          this.applyTheme();
        },
        async loadSites(){
          try { const r= await fetch('/api/facial-subunits'); if(r.ok){ const j= await r.json(); this.sites=j.subunits||[]; } } catch(e){ console.warn(e); }
          if(!this.sites.length){ this.sites=[{value:'forehead',label:'Forehead'},{value:'cheek_medial',label:'Medial Cheek'},{value:'nose_tip',label:'Nasal Tip'}]; }
        },
        applyTheme(){ document.documentElement.dataset.theme=this.theme; },
        formatSize(b){ if(!b) return ''; const u=['B','KB','MB']; const i=Math.floor(Math.log(b)/Math.log(1024)); return (b/1024**i).toFixed(1)+' '+u[i]; },
        fileChosen(e){ const f=e.target.files[0]; if(f) this.useFile(f); },
        handleDrop(e){ const f=e.dataTransfer.files?.[0]; if(f) this.useFile(f); },
        useFile(f){ try{ surgicalAI.validateImageFile(f); this.selectedFile=f; const rd=new FileReader(); rd.onload=(ev)=>{this.imagePreview=ev.target.result}; rd.readAsDataURL(f); this.error=null;}catch(err){ this.error=err.message; } },
        clearImage(){ this.selectedFile=null; this.imagePreview=null; },
        get canAnalyze(){ return this.selectedFile && this.form.site && !this.analyzing; },
        async refreshHealth(){ this.checkingHealth=true; this.health= await surgicalAI.getHealth(); this.checkingHealth=false; },
        async analyze(){
          if(!this.canAnalyze) return;
          this.analyzing=true; this.error=null; this.results=null;
          try{
            const flags={sex:this.form.sex, age:this.form.age, prior_histology:this.form.prior_histology, ill_defined_borders:this.form.ill_defined_borders, recurrent:this.form.recurrent, risk_factors:this.form.risk};
            const res= await surgicalAI.postAnalyze({file:this.selectedFile, site:this.form.site, suspected:this.form.suspected, flags});
            this.lastRequestId = res.json?.run_id || null;
            this.results = this.mapResults(res.json, res.artifacts);
          }catch(err){ this.error = err.message || 'Analysis failed'; }
          this.analyzing=false;
        },
        mapResults(data, artifacts){
          if(!data) return null;
          // unify legacy/simple response into UI shape
          const probsEntries = data.probs ? Object.entries(data.probs).map(([k,v])=>({condition:k.replace(/_/g,' '), percentage: Math.round((v||0)*100)})) : [];
          probsEntries.sort((a,b)=> b.percentage - a.percentage);
          return {
            sortedDiagnosis: probsEntries,
            primaryDx: probsEntries[0]?.condition || null,
            gate: data.gate || null,
            // Prefer normalized artifacts list (names without suffix) then fall back to legacy keys
            heatmapUrl: artifacts?.heatmap?.url || data.artifacts?.heatmap_png || data.artifacts?.heatmap,
            reportUrl: artifacts?.report?.url || data.artifacts?.report_pdf || data.artifacts?.report_html || data.artifacts?.pdf
          };
        },
        openReport(){ if(this.results?.reportUrl) window.open(this.results.reportUrl,'_blank'); },
  reset(){ this.clearImage(); this.form={site:'', suspected:'', age:null, sex:'Male', prior_histology:false, ill_defined_borders:false, recurrent:false, risk:{smoking:false, uv:false, immunosuppression:false, family_history:false, prior_radiation:false, fitzpatrick:''}}; this.results=null; this.error=null; }
      }
    }
  </script>
</body>
</html>

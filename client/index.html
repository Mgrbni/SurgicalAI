...existing code...
<!DOCTYPE html>
<html lang="en" data-theme="light">
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SurgicalAI — Minimal Dashboard</title>
    <style>
        :root{
            --bg:#0b0f14; --card:#10161d; --soft:#15202b; --muted:#1b2733; --text:#e6eef6; --sub:#9fb3c8; --accent:#3fb950; --danger:#e5534b; --warn:#ffb100; --border:#22303c;
        }
        html,body{height:100%}
        body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
        .wrap{max-width:1080px;margin:0 auto;padding:16px}
        header{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
        header h1{margin:0;font-size:18px}
        header .badge{font-size:11px;background:#341d1d;color:#ffb4b4;border:1px solid #4a2626;border-radius:12px;padding:2px 8px;margin-left:8px}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        <!doctype html>
        .card{background:var(--card);border:1px solid var(--border);border-radius:12px}
        .card .hd{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:600}
        .card .bd{padding:14px}
        .btn{cursor:pointer;border:1px solid var(--border);background:var(--soft);color:var(--text);padding:8px 12px;border-radius:8px}
        .btn[disabled]{opacity:.5;cursor:not-allowed}
        .btn.primary{background:var(--accent);border-color:#2e7b3a;color:#07130a}
        .btn.danger{background:#3a1613;border-color:#5b2520;color:#ffcac7}
        .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .row + .row{margin-top:8px}
        label.small{font-size:12px;color:var(--sub)}
        input, select{background:var(--soft);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px;width:100%}
        .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .drop{border:2px dashed var(--border);border-radius:10px;padding:16px;text-align:center;color:var(--sub)}
        .canvasWrap{position:relative;background:var(--soft);border:1px solid var(--border);border-radius:10px;overflow:hidden}
        #canvas{display:block;width:100%;height:auto;cursor:crosshair}
        .hint{font-size:12px;color:var(--sub)}
        .bar{height:8px;background:#22303c;border-radius:999px;overflow:hidden}
        .bar > span{display:block;height:100%;background:var(--accent)}
        .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:var(--soft);color:var(--sub);font-size:12px}
        .toast{position:fixed;top:12px;right:12px;background:var(--card);border:1px solid var(--border);border-left:4px solid var(--accent);padding:10px 12px;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,.3);z-index:50}
        .toast.err{border-left-color:var(--danger)}
        footer{opacity:.7;font-size:12px;padding:12px 0}
        .small{font-size:12px;color:var(--sub)}
        .space{height:8px}
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <div class="row">
                <h1>SurgicalAI</h1>
                <span class="badge">Not for clinical use</span>
            </div>
            <div id="health" class="small">health: <span>checking…</span></div>
        </header>

        <div class="grid">
            <section class="card">
                <div class="hd">Image and ROI</div>
                <div class="bd">
                    <div class="drop" id="drop">
                        <input id="file" type="file" accept="image/*" style="display:none">
                        <div id="dropMsg">Drop image here or click to choose</div>
                    </div>
                    <div class="space"></div>
                    <div class="canvasWrap">
                        <canvas id="canvas"></canvas>
                    </div>
                    <div class="row" style="margin-top:8px">
                        <button class="btn" id="startPoly">Start polygon</button>
                        <button class="btn" id="finishPoly">Finish</button>
                        <button class="btn danger" id="clearPoly">Clear</button>
                        <span class="hint">Click on the image to add vertices. Minimum 3 points.</span>
                    </div>
                </div>
            </section>

            <section class="card">
                <div class="hd">Parameters</div>
                <div class="bd">
                    <div class="row">
                        <label class="small" for="site">Facial subunit</label>
                        <select id="site">
                            <option value="">Select…</option>
                            <option value="forehead">Forehead</option>
                            <option value="temple">Temple</option>
                            <option value="cheek_medial">Medial Cheek</option>
                            <option value="cheek_lateral">Lateral Cheek</option>
                            <option value="nose_dorsum">Nasal Dorsum</option>
                            <option value="nose_tip">Nasal Tip</option>
                            <option value="nose_ala">Nasal Ala</option>
                            <option value="lip_upper">Upper Lip</option>
                            <option value="lip_lower">Lower Lip</option>
                            <option value="chin">Chin</option>
                        </select>
                    </div>
                    <div class="row" style="margin-top:8px">
                        <label class="small" for="flap">Flap type</label>
                        <select id="flap">
                            <option value="auto">Auto (recommended)</option>
                            <option value="v-y">V-Y</option>
                            <option value="keystone">Keystone</option>
                            <option value="rotation">Rotation</option>
                            <option value="limberg">Limberg</option>
                            <option value="bilobed">Bilobed</option>
                            <option value="nasolabial">Nasolabial</option>
                            <option value="paramedian_forehead">Paramedian Forehead</option>
                        </select>
                    </div>
                    <div class="two" style="margin-top:8px">
                        <div>
                            <label class="small" for="age">Age</label>
                            <input id="age" type="number" min="0" max="120" placeholder="e.g., 54">
                        </div>
                        <div>
                            <label class="small" for="sex">Sex</label>
                            <select id="sex">
                                <option>Male</option>
                                <option>Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="row" style="margin-top:8px">
                        <label><input type="checkbox" id="hZone"> H-Zone</label>
                        <label><input type="checkbox" id="illBorders"> Ill-defined borders</label>
                        <label><input type="checkbox" id="recurrent"> Recurrent tumor</label>
                    </div>
                    <div class="row" style="margin-top:12px">
                        <button class="btn primary" id="analyze" disabled>Analyze</button>
                        <button class="btn" id="exportPdf" disabled>Export PDF</button>
                        <input id="doctor" type="text" placeholder="Doctor name (optional)" style="max-width:220px"/>
                        <button class="btn" id="reset">Reset</button>
                        <span id="req" class="small"></span>
                    </div>
                </div>
            </section>

            <section class="card" style="grid-column:1/-1">
                <div class="hd">Results</div>
                <div class="bd" id="results">
                    <div class="small">No results yet. Upload, mark ROI, choose site, then Analyze.</div>
                </div>
            </section>
        </div>

        <footer>
            © Dr. Mehdi Ghorbani Karimabad — Educational use only.
        </footer>
    </div>

    <script src="api.js"></script>
    <script>
        // State
        const els = {
            drop: document.getElementById('drop'), file: document.getElementById('file'), dropMsg: document.getElementById('dropMsg'),
            canvas: document.getElementById('canvas'), start: document.getElementById('startPoly'), finish: document.getElementById('finishPoly'), clear: document.getElementById('clearPoly'),
            site: document.getElementById('site'), age: document.getElementById('age'), sex: document.getElementById('sex'),
            hZone: document.getElementById('hZone'), ill: document.getElementById('illBorders'), rec: document.getElementById('recurrent'),
            analyze: document.getElementById('analyze'), reset: document.getElementById('reset'), results: document.getElementById('results'), req: document.getElementById('req'), health: document.querySelector('#health span')
        };

        const state = {
            img: null, imgDataUrl: null, file: null,
            polyActive: false, pts: [], // points in normalized coords [x,y] w.r.t canvas size
            analyzing: false,
            lastResult: null
        };

        // Health
        (async () => {
            try { const h = await surgicalAI.getHealth(); els.health.textContent = h.ok ? 'ok' : 'unhealthy'; } catch { els.health.textContent = 'offline'; }
        })();

        // Toast
        function toast(msg, kind){
            const t = document.createElement('div'); t.className = 'toast' + (kind==='err'?' err':''); t.textContent = msg; document.body.appendChild(t);
            setTimeout(()=>{ t.remove(); }, 3500);
        }

        // Canvas helpers
        const ctx = els.canvas.getContext('2d');
        function fitAndDraw(){
            if(!state.img) return; const maxW = els.canvas.parentElement.clientWidth; const scale = Math.min(maxW / state.img.naturalWidth, 600 / state.img.naturalHeight, 1);
            const w = Math.round(state.img.naturalWidth * scale); const h = Math.round(state.img.naturalHeight * scale);
            const dpr = window.devicePixelRatio || 1; els.canvas.style.width = w+'px'; els.canvas.style.height = h+'px'; els.canvas.width = Math.round(w*dpr); els.canvas.height = Math.round(h*dpr);
            ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,w,h); ctx.drawImage(state.img, 0, 0, w, h); drawPoly(w,h);
        }
        function drawPoly(w = els.canvas.width, h = els.canvas.height){
            const dpr = window.devicePixelRatio || 1; ctx.save(); ctx.lineWidth = 2; ctx.strokeStyle = '#e5534b'; ctx.fillStyle = 'rgba(229,83,75,0.12)';
            const px = p => [p[0]*(els.canvas.width/dpr), p[1]*(els.canvas.height/dpr)];
            if(state.pts.length){ ctx.beginPath(); const [x0,y0] = px(state.pts[0]); ctx.moveTo(x0,y0); for(let i=1;i<state.pts.length;i++){ const [x,y] = px(state.pts[i]); ctx.lineTo(x,y); }
                if(!state.polyActive && state.pts.length>=3){ ctx.closePath(); ctx.fill(); }
                ctx.stroke(); }
            ctx.restore();
        }
        function addPointFromEvent(e){
            if(!state.polyActive) return; const rect = els.canvas.getBoundingClientRect(); const x = (e.clientX - rect.left)/rect.width; const y = (e.clientY - rect.top)/rect.height;
            state.pts.push([Math.max(0,Math.min(1,x)), Math.max(0,Math.min(1,y))]); fitAndDraw(); updateAnalyzeEnabled();
        }

        // File handling
        els.drop.addEventListener('click', ()=> els.file.click());
        els.drop.addEventListener('dragover', e => { e.preventDefault(); els.drop.style.borderColor = '#3fb950'; });
        els.drop.addEventListener('dragleave', e => { e.preventDefault(); els.drop.style.borderColor = 'var(--border)'; });
        els.drop.addEventListener('drop', e => { e.preventDefault(); els.drop.style.borderColor = 'var(--border)'; if(e.dataTransfer.files?.[0]) loadFile(e.dataTransfer.files[0]); });
        els.file.addEventListener('change', e => { if(e.target.files?.[0]) loadFile(e.target.files[0]); });
        function loadFile(file){
            try { SurgicalAI.validateImage(file); } catch (err) { toast(err.message, 'err'); return; }
            state.file = file; const fr = new FileReader(); fr.onload = () => { state.imgDataUrl = fr.result; const img = new Image(); img.onload = ()=>{ state.img = img; state.pts = []; state.polyActive = false; fitAndDraw(); updateAnalyzeEnabled(); }; img.src = state.imgDataUrl; }; fr.readAsDataURL(file);
            els.dropMsg.textContent = file.name + ' (' + SurgicalAI.formatFileSize(file.size) + ')';
        }

        // Polygon controls
        els.start.addEventListener('click', ()=>{ if(!state.img){ toast('Load an image first','err'); return; } state.pts = []; state.polyActive = true; fitAndDraw(); updateAnalyzeEnabled(); });
        els.finish.addEventListener('click', async ()=>{
            state.polyActive = false; fitAndDraw(); updateAnalyzeEnabled();
            // Auto-send to backend for classification (Claude) after ROI is finished
            if(state.img && state.pts.length>=3 && els.site.value){
                state.analyzing = true; updateAnalyzeEnabled(); els.analyze.textContent = 'Analyzing…';
                try{
                    const base64 = String(state.imgDataUrl).split(',')[1];
                    const risks = {
                        smoker:false, uv_high:false, immunosuppressed:false, radiated:false, anticoagulants:false, diabetes:false,
                        ill_defined_borders: !!els.ill.checked, recurrent_tumor: !!els.rec.checked
                    };
                    // Use Claude unless offline is checked
                    const provider = els.hZone.checked ? 'anthropic' : null;
                    const { json, requestId } = await surgicalAI.triage({
                        imageBase64: base64,
                        roiPolygon: state.pts.slice(),
                        site: els.site.value,
                        age: Number(els.age.value||0) || null,
                        sex: els.sex.value,
                        risks,
                        offline: false,
                        provider
                    });
                    els.req.textContent = requestId ? 'Request-ID: '+requestId : '';
                    state.lastResult = json; renderResults(json);
                    if(json && json.overlay) drawOverlay(json.overlay);
                    toast('Analysis complete');
                }catch(err){
                    const msg = err?.message || 'Analysis failed'; toast(msg, 'err');
                }finally{ state.analyzing = false; els.analyze.textContent = 'Analyze'; updateAnalyzeEnabled(); }
            }
        });
        els.clear.addEventListener('click', ()=>{ state.polyActive = false; state.pts = []; fitAndDraw(); updateAnalyzeEnabled(); });
        els.canvas.addEventListener('mousedown', addPointFromEvent);
        window.addEventListener('resize', fitAndDraw);

        // Analyze
        function updateAnalyzeEnabled(){ els.analyze.disabled = !(state.file && els.site.value && state.pts.length>=3 && !state.analyzing); }
        function updateAnalyzeEnabled(){
            els.analyze.disabled = !(state.file && els.site.value && state.pts.length>=3 && !state.analyzing);
            els.exportPdf.disabled = !state.lastResult ? true : false;
            els.exportPdf.style.opacity = els.exportPdf.disabled ? 0.5 : 1;
        }
        ['change','input'].forEach(ev=> els.site.addEventListener(ev, updateAnalyzeEnabled));
        els.analyze.addEventListener('click', async ()=>{
            if(els.analyze.disabled) return; state.analyzing = true; updateAnalyzeEnabled(); els.analyze.textContent = 'Analyzing…';
            try{
                const base64 = String(state.imgDataUrl).split(',')[1];
                const risks = {
                    smoker:false, uv_high:false, immunosuppressed:false, radiated:false, anticoagulants:false, diabetes:false,
                    ill_defined_borders: !!els.ill.checked, recurrent_tumor: !!els.rec.checked
                };
                const { json, requestId } = await surgicalAI.triage({
                    imageBase64: base64,
                    roiPolygon: state.pts.slice(),
                    site: els.site.value,
                    age: Number(els.age.value||0) || null,
                    sex: els.sex.value,
                    risks,
                    offline: true
                });
                els.req.textContent = requestId ? 'Request-ID: '+requestId : '';
                state.lastResult = json; renderResults(json);
                // overlay vectors if provided
                if(json && json.overlay) drawOverlay(json.overlay);
                toast('Analysis complete');
            } catch(err){
                const msg = err?.message || 'Analysis failed'; toast(msg, 'err');
            } finally { state.analyzing = false; els.analyze.textContent = 'Analyze'; updateAnalyzeEnabled(); }
        });

        function renderResults(json){
            const top = (json?.diagnostics?.top3||[]).map(p=>({label:(p.label||'').replace(/_/g,' '), pct: Math.round((p.prob||0)*100)}));
            const primary = top[0]?.label || '—';
            const flap = json?.reconstruction?.primary?.type || json?.reconstruction?.suggestion || null;
            els.results.innerHTML = '';
            const container = document.createElement('div');
            if(top.length){
                top.forEach(item=>{
                    const row = document.createElement('div'); row.style.margin = '6px 0';
                    row.innerHTML = `<div class="row" style="justify-content:space-between"><strong>${item.label}</strong><span>${item.pct}%</span></div><div class="bar"><span style="width:${item.pct}%"></span></div>`;
                    container.appendChild(row);
                });
            }
            const primaryEl = document.createElement('div'); primaryEl.style.margin = '10px 0 0'; primaryEl.innerHTML = `<span class="pill">Primary</span> <strong>${primary}</strong>`; container.appendChild(primaryEl);
            if(flap){ const flapEl = document.createElement('div'); flapEl.style.marginTop='10px'; flapEl.innerHTML = `<span class="pill">Flap</span> ${flap}`; container.appendChild(flapEl); }

            // Flap geometry & guideline info
            const flapPlan = json?.flap_plan || json?.reconstruction?.primary || null;
            if(flapPlan && flapPlan.params && (flapPlan.params.geometry || flapPlan.params.indications)){
                const p = flapPlan.params;
                const infoDiv = document.createElement('div');
                infoDiv.style = 'border:1px solid #1976d2; background:#f5faff; border-radius:8px; padding:12px; margin-top:16px;';
                infoDiv.innerHTML = `
                    <h4 style="color:#1976d2; margin-bottom:4px;">Flap Geometry & Guidelines</h4>
                    <b>Type:</b> ${flapPlan.type}<br>
                    <b>Geometry:</b> ${p.geometry}<br>
                    <b>Indications:</b> <span style="color:#388e3c">${p.indications}</span><br>
                    <b>Contraindications:</b> <span style="color:#d32f2f">${p.contraindications}</span><br>
                    <b>How-to:</b> <span style="color:#333">${p.howto}</span>
                `;
                container.appendChild(infoDiv);
            }

            // Oncology gates and margins
            const onc = json?.oncology || {};
            const gates = onc?.gates || {};
            const oncDiv = document.createElement('div'); oncDiv.style.marginTop = '12px';
            const gateStr = Object.keys(gates).length ? Object.entries(gates).map(([k,v])=>`${k.replace(/_/g,' ')}: ${v?'Yes':'No'}`).join(' • ') : '';
            oncDiv.innerHTML = `<span class="pill">Oncology</span> Margin: ${onc?.recommended_margin_mm??'—'} mm ${gateStr? ' • '+gateStr:''}`;
            container.appendChild(oncDiv);

            // Protocol / guideline info
            const proto = json?.protocol;
            if(proto){
                const pDiv = document.createElement('div'); pDiv.style.marginTop='10px';
                const srcs = (proto.sources||[]).slice(0,5).join(', ');
                pDiv.innerHTML = `<span class="pill">Protocol</span> ${proto.name||'SurgicalAI Clinical Protocol'} v${proto.version||''}${srcs? ' — Sources: '+srcs:''}`;
                container.appendChild(pDiv);
            }

            // Citations
            const cites = json?.citations || [];
            if(cites.length){
                const cDiv = document.createElement('div'); cDiv.style.marginTop='10px';
                cDiv.innerHTML = `<span class="pill">Citations</span> ${cites.map(c=>`<span class="small">${c}</span>`).join(' • ')}`;
                container.appendChild(cDiv);
            }
            els.results.appendChild(container);
        }

        function drawOverlay(overlay){
            // Redraw base image and ROI
            fitAndDraw();
            const dpr = window.devicePixelRatio || 1; const w = els.canvas.width/dpr; const h = els.canvas.height/dpr;
            ctx.save(); ctx.lineWidth = 2; ctx.strokeStyle = '#3fb950';
            const poly = overlay?.excision?.points||[]; if(poly.length>1){ ctx.beginPath(); for(let i=0;i<poly.length;i++){ const [x,y]=poly[i]; const cx=x*w, cy=y*h; if(i===0) ctx.moveTo(cx,cy); else ctx.lineTo(cx,cy);} ctx.closePath(); ctx.stroke(); }
            // Fix RSTL orientation: always use correct angle from backend
            const cl = overlay?.closure?.lines?.[0];
            if(cl){
                ctx.strokeStyle = '#58a6ff';
                ctx.beginPath();
                ctx.moveTo(cl[0][0]*w, cl[0][1]*h);
                ctx.lineTo(cl[1][0]*w, cl[1][1]*h);
                ctx.stroke();
            }
            const flap = overlay?.overlay_flap_points || overlay?.flap?.points || [];
            if(flap.length>1){
                ctx.strokeStyle = '#ffb100';
                ctx.beginPath();
                for(let i=0;i<flap.length;i++){
                    const [x,y]=flap[i];
                    const cx=x*w, cy=y*h;
                    if(i===0) ctx.moveTo(cx,cy); else ctx.lineTo(cx,cy);
                }
                ctx.stroke();
            }
            ctx.restore();
        }

        // Reset
        els.reset.addEventListener('click', ()=>{
            state.img = null; state.imgDataUrl = null; state.file = null; state.pts = []; state.polyActive = false;
            els.file.value = ''; els.dropMsg.textContent = 'Drop image here or click to choose'; els.site.value = ''; els.age.value=''; els.sex.value='Male'; els.hZone.checked = els.ill.checked = els.rec.checked = false; els.results.innerHTML = '<div class="small">No results yet.</div>'; els.req.textContent=''; els.doctor.value='';
            state.lastResult = null;
            ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,els.canvas.width,els.canvas.height); updateAnalyzeEnabled();
        });

        // Export PDF
        els.exportPdf = document.getElementById('exportPdf');
        els.doctor = document.getElementById('doctor');
        els.exportPdf.addEventListener('click', async ()=>{
            if(!state.lastResult){ toast('Run an analysis first','err'); return; }
            try{
                const { blob, requestId } = await surgicalAI.generateReport(state.lastResult, els.doctor.value || null);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const ts = new Date().toISOString().replace(/[:.]/g,'-');
                a.href = url; a.download = `surgical_report_${requestId||ts}.pdf`; a.click();
                URL.revokeObjectURL(url);
                toast('PDF downloaded');
            }catch(err){ toast(err?.message||'PDF export failed','err'); }
        });
    </script>
</body>
</html>